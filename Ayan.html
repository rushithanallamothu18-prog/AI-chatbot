<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ayan - College Chatbot (Fixed Attendance & Timetable SVG + Lunch)</title>
<style>
/* --- YOUR ORIGINAL STYLING PRESERVED --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: linear-gradient(135deg, #001f3f, #000000, #d3d3d3);
  font-family: 'Poppins', sans-serif;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.container {
  width: 100%;
  max-width: 420px;
  background: rgba(255, 255, 255, 0.97);
  border-radius: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  padding: 25px 20px;
  transition: all 0.5s ease;
}
.hidden { display: none; }

/* Welcome Text */
#welcome-text {
  text-align: center;
  font-size: 1.5em;
  margin-bottom: 25px;
  font-weight: bold;
  color: #000;
}

/* Inputs & Buttons */
input, select {
  padding: 12px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  width: 100%;
  font-size: 1em;
  transition: 0.3s;
}
input:focus, select:focus {
  border-color: #001f3f;
  outline: none;
  box-shadow: 0 0 5px rgba(0,31,63,0.3);
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 1em;
  color: white;
  background: linear-gradient(135deg, #001f3f, #000000, #d3d3d3);
  transition: all 0.3s;
}
button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

.error {
  color: red;
  font-size: 0.9em;
  margin-bottom: 10px;
  text-align: center;
}

/* Toggle Buttons */
.toggle-buttons {
  display: flex;
  margin-bottom: 15px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid black;
}
.toggle-buttons button {
  flex: 1;
  padding: 10px 0;
  background: white;
  color: black;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
.toggle-buttons button.active {
  background: black;
  color: white;
}

/* Forgot Password Link */
.forgot-link {
  text-align: center;
  color: #001f3f;
  cursor: pointer;
  font-size: 0.9em;
  text-decoration: underline;
  margin-top: 5px;
  transition: color 0.3s;
}
.forgot-link:hover { color: #000; }

/* Chat Styles */
.chat-header {
  background: linear-gradient(135deg, #001f3f, #000000, #d3d3d3);
  color: white;
  padding: 15px;
  text-align: center;
  font-size: 1.2em;
  border-radius: 10px 10px 0 0;
}
.chat-body {
  flex: 1;
  background: #f5f5f5;
  padding: 15px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  height: 350px;
  margin-bottom: 10px;
  border-radius: 0 0 10px 10px;
}
.message {
  margin: 8px 0;
  display: flex;
  opacity: 0;
  transform: translateY(20px);
  transition: 0.5s;
}
.message.show {
  opacity: 1;
  transform: translateY(0);
}
.bot-message { justify-content: flex-start; }
.user-message { justify-content: flex-end; }
.bubble {
  max-width: 70%;
  padding: 10px 15px;
  border-radius: 20px;
  font-size: 0.95em;
  line-height: 1.4;
  word-break: break-word;
}
.bot-message .bubble {
  background: #e0e0e0;
  color: #333;
  border-bottom-left-radius: 0;
}
.user-message .bubble {
  background: linear-gradient(135deg, #001f3f, #000000, #d3d3d3);
  color: white;
  border-bottom-right-radius: 0;
}
.input-area {
  display: flex;
  gap: 10px;
}
.input-area input {
  flex: 1;
  padding: 10px;
  border-radius: 25px;
  border: 1px solid #ccc;
  font-size: 1em;
}
.input-area button {
  width: auto;
  padding: 10px 15px;
  border-radius: 50%;
}
.role-display {
  text-align: center;
  margin-bottom: 10px;
  font-weight: bold;
}

/* Responsive */
@media (max-width: 500px) {
  .container { max-width: 95%; padding: 20px; }
  .chat-body { height: 250px; }
}

/* table and menu styles inside messages */
table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size:0.95em; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #001f3f; color: white; }
.menu-section { margin-top: 10px; }
.menu-section h4 { margin-top: 10px; color: #001f3f; }

/* tooltip for table rows (shows full form on hover) */
.tooltip-row { position: relative; }
.tooltip-row:hover::after {
  content: attr(data-full);
  position: absolute;
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 6px 8px;
  border-radius: 6px;
  top: -34px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 0.8em;
}

/* Ensure images inside bubble fit and don't stretch chat */
.bubble img {
  max-width: 320px; /* small horizontal image width */
  width: 100%;
  height: auto;
  display: block;
  border-radius: 8px;
}

/* legend style lines */
.legend-line { margin-top: 6px; font-size: 13px; }
.legend-line strong { display:inline-block; width:70px; }
.bubble .highlight { color: #b30000; font-weight:700; }
</style>
</head>
<body>

<!-- Login / Signup Page -->
<div class="container" id="login-section" style="height:550px;">
  <div id="welcome-text">Welcome to Chatbotü§ñ</div>
  <div class="error" id="login-error"></div>

  <div class="toggle-buttons">
    <button id="login-tab" class="active" onclick="showTab('login')">Login</button>
    <button id="signup-tab" onclick="showTab('signup')">Sign Up</button>
  </div>

  <!-- Login Form -->
  <div id="login-form">
    <input type="email" id="login-email" placeholder="Enter your email" />
    <input type="password" id="login-password" placeholder="Enter your password" />
    <button onclick="handleLogin()">Login</button>
    <div class="forgot-link" onclick="showForgotPassword()">Forgot my password?</div>
  </div>

  <!-- Signup Form -->
  <div id="signup-form" class="hidden">
    <input type="email" id="signup-email" placeholder="Enter your email" />
    <input type="password" id="signup-password" placeholder="Enter your password" />
    <input type="password" id="signup-confirm" placeholder="Confirm password" />
    <button onclick="handleSignUp()">Sign Up</button>
  </div>
</div>

<!-- Forgot Password Page -->
<div class="container hidden" id="forgot-section" style="height:550px;">
  <div id="welcome-text">Forgot Password üîê</div>
  <p style="text-align:center; margin-bottom:15px;">Enter your registered email address below:</p>
  <input type="email" id="forgot-email" placeholder="Enter your email" />
  <button onclick="handleForgotPassword()">Submit</button>
  <div class="forgot-link" onclick="backToLogin()">‚Üê Back to Login</div>
  <div class="error" id="forgot-message" style="color:green; font-weight:bold; margin-top:10px;"></div>
</div>

<!-- Role Selection Page -->
<div class="container hidden" id="role-section">
  <h2>Select Your Role</h2>
  <select id="role-select">
    <option value="">-- Select Role --</option>
    <option value="public">Public</option>
    <option value="student">Student</option>
    <option value="faculty">Faculty</option>
    <option value="admin">Admin</option>
  </select>
  <button onclick="selectRole()">Continue</button>
</div>

<!-- Chat Page -->
<div class="container hidden" id="chat-section">
  <div class="chat-header">üí¨ Ayan - Campus Chatbot</div>
  <div class="role-display" id="role-display"></div>
  <div class="chat-body" id="chat-box">
    <div class="bot-message message show">
      <div class="bubble">Hi, I'm Ayan your campus assistant. How can I help you?</div>
    </div>
  </div>
  <div class="input-area">
    <input type="text" id="user-input" placeholder="Type your message..." />
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script>
/* ------------------------------
   Data and session
   ------------------------------ */
let user = {
  email: "",
  password: "",
  role: "",
  studentTimetable: null,
  classAverageAttendance: null,
  classAveragePerformance: null
};

const courseSubjects = {
  cse: [
    "Year 1: Programming, Mathematics, Physics, Basic Engineering",
    "Year 2: Data Structures, Discrete Maths, DBMS, Computer Org",
    "Year 3: Operating Systems, Networks, Algorithms, Software Engg",
    "Year 4: AI, ML, Cloud Computing, Major Project"
  ],
  aiml: [
    "Year 1: Python, Calculus, Linear Algebra, Intro CS",
    "Year 2: Statistics, Data Structures, ML Basics, Linear Models",
    "Year 3: Deep Learning, NLP, Computer Vision, Neural Networks",
    "Year 4: Reinforcement Learning, Big Data, Project, Ethics"
  ],
  ds: [
    "Year 1: Math, Python, Probability, Intro to Data",
    "Year 2: Statistics, Data Mining, Databases, Visualization",
    "Year 3: ML, Big Data Analytics, Time Series, Modeling",
    "Year 4: Model Deployment, Advanced ML, Project, Ethics"
  ],
  it: [
    "Year 1: Programming Basics, Computer Fundamentals, Maths",
    "Year 2: Web Tech, DBMS, Networks",
    "Year 3: Cyber Security, Software Engg, Cloud",
    "Year 4: DevOps, Data Analytics, Project, Electives"
  ],
  iot: [
    "Year 1: Electronics, Programming, Maths",
    "Year 2: Embedded Systems, Sensors, Microcontrollers",
    "Year 3: Wireless Networks, IoT Architecture, Analytics",
    "Year 4: IoT Security, Edge Computing, Project"
  ],
  arvr: [
    "Year 1: Graphics & Programming, Maths, Design Fundamentals",
    "Year 2: 3D Modeling, Computer Graphics, UX",
    "Year 3: Unity/Unreal, AR & VR Development, Interaction Design",
    "Year 4: XR Applications, Game Design, Optimization, Project"
  ]
};

let events = [
  { name: "Hackathon", date: "2025-11-05", type: "technical" },
  { name: "Technical Paper Presentation", date: "2025-11-10", type: "technical" },
  { name: "Web Dev Challenge", date: "2025-11-14", type: "technical" },
  { name: "Cultural Fest - Rangotsav", date: "2025-11-20", type: "non-technical" },
  { name: "Sports Meet", date: "2025-11-25", type: "non-technical" },
  { name: "Farewell Function", date: "2025-11-30", type: "non-technical" }
];

const examSchedule = [
  { subject: "English", date: "2025-11-08" },
  { subject: "Mathematics", date: "2025-11-10" },
  { subject: "Python", date: "2025-11-12" },
  { subject: "AI", date: "2025-11-14" },
  { subject: "Physics", date: "2025-11-16" },
  { subject: "DBMS", date: "2025-11-18" }
];

/* ------------------------------
   Utilities
   ------------------------------ */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function formatEventsHTML(){
  let html = "<b>Upcoming Events (Nov 2025):</b><br><ul>";
  events.forEach(ev => html += `<li><strong>${ev.name}</strong> ‚Äî ${ev.date} (${ev.type})</li>`);
  html += "</ul>";
  return html;
}

/* ------------------------------
   UI functions (unchanged)
   ------------------------------ */
function showTab(tab) {
  const loginBtn = document.getElementById("login-tab");
  const signupBtn = document.getElementById("signup-tab");
  const loginForm = document.getElementById("login-form");
  const signupForm = document.getElementById("signup-form");
  if (tab === "login") {
    loginBtn.classList.add("active");
    signupBtn.classList.remove("active");
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
  } else {
    signupBtn.classList.add("active");
    loginBtn.classList.remove("active");
    signupForm.classList.remove("hidden");
    loginForm.classList.add("hidden");
  }
}
function showForgotPassword() { transitionPage("login-section","forgot-section"); }
function backToLogin() { transitionPage("forgot-section","login-section"); }
function handleForgotPassword(){
  const email = document.getElementById("forgot-email").value.trim();
  const msg = document.getElementById("forgot-message");
  if(!email || !email.includes("@")) { msg.style.color="red"; msg.textContent="Please enter a valid registered email."; return; }
  msg.style.color="green"; msg.textContent="‚úÖ A link is sent to your email, reset your password using the link.";
  setTimeout(()=>{ msg.textContent=""; backToLogin(); }, 3000);
}
function handleLogin() {
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value.trim();
  const error = document.getElementById("login-error");
  if (!email.includes("@")) { error.textContent = "Please enter a valid email."; return; }
  if (!password) { error.textContent = "Please enter your password."; return; }
  user.email = email; user.password = password; error.textContent = "";
  transitionPage("login-section","role-section");
}
function handleSignUp(){
  const email = document.getElementById("signup-email").value.trim();
  const pass = document.getElementById("signup-password").value.trim();
  const confirm = document.getElementById("signup-confirm").value.trim();
  const error = document.getElementById("login-error");
  if(!email.includes("@")){ error.textContent="Please enter a valid email."; return; }
  if(!pass || !confirm){ error.textContent="Please fill all fields."; return; }
  if(pass !== confirm){ error.textContent="Passwords do not match."; return; }
  user.email = email; user.password = pass; error.textContent = "";
  transitionPage("login-section","role-section");
}
function transitionPage(fromId, toId) {
  document.getElementById(fromId).classList.add("hidden");
  document.getElementById(toId).classList.remove("hidden");
}
function selectRole() {
  const role = document.getElementById("role-select").value;
  if (!role) { alert("Please select a role."); return; }
  user.role = role;
  // generate class averages once per session
  if (user.classAverageAttendance === null) user.classAverageAttendance = randInt(78,92);
  if (user.classAveragePerformance === null) user.classAveragePerformance = randInt(70,88);
  // generate a compact short-code timetable for students (short codes only)
  if (role === "student" && user.studentTimetable === null) user.studentTimetable = generateShortCodeTimetable();
  document.getElementById("role-display").textContent = `Role: ${role}`;
  transitionPage("role-section","chat-section");
}

/* ------------------------------
   Timetable generator + SVG renderer (small horizontal image)
   - Short subject codes in cells
   - Single LUNCH column (12-1) drawn as one long bar (not split by days)
   ------------------------------ */
const shortSubjects = ["CSE","AIML","DS","IT","IOT","ARVR","LIB","SPORTS","DANCE"];

function generateShortCodeTimetable(){
  // NOTE: slots include the lunch slot "12-1" at index 3
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat"];
  const slots = ["9-10","10-11","11-12","12-1","1-2","2-3","3-4"];
  const table = {};
  for(let d of days){
    table[d] = [];
    for(let i=0;i<slots.length;i++){
      if(slots[i] === "12-1"){
        // for lunch column we'll store a placeholder (not used per-day)
        table[d].push("LUNCH");
      } else {
        // choose mostly technical course codes, occasional activities
        const pick = Math.random() < 0.75 ? shortSubjects[Math.floor(Math.random()*6)] : shortSubjects[6 + Math.floor(Math.random()*3)];
        table[d].push(pick);
      }
    }
  }
  return { days, slots, table };
}

/* Draw SVG with a special lunch column that is a single tall bar */
function timetableToSVGDataURLShort(tt){
  const width = 320;
  const colCount = tt.slots.length + 1; // +1 for day column
  const colW = Math.floor(width / colCount);
  const rowH = 26;
  const height = rowH * (tt.days.length + 1);
  const lunchIndex = tt.slots.indexOf("12-1"); // should be 3
  let svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${width}' height='${height}' viewBox='0 0 ${width} ${height}'>`;
  svg += `<rect width='100%' height='100%' rx='8' fill='#ffffff' />`;
  svg += `<g font-family='Poppins, Arial' font-size='10' fill='#000'>`;
  // header row - day cell
  svg += `<rect x='0' y='0' width='${colW}' height='${rowH}' fill='#001f3f' />`;
  svg += `<text x='${colW/2}' y='${rowH/2+4}' text-anchor='middle' fill='#fff' font-weight='600'>Day</text>`;
  // header slots
  for(let i=0;i<tt.slots.length;i++){
    const x = colW + i*colW;
    svg += `<rect x='${x}' y='0' width='${colW}' height='${rowH}' fill='${tt.slots[i]==="12-1"?"#ffcc66":"#00a3ff"}' />`;
    svg += `<text x='${x + colW/2}' y='${rowH/2+4}' text-anchor='middle' fill='#000' font-weight='600'>${escapeXml(tt.slots[i])}</text>`;
  }

  // If lunch column exists, draw a single tall rect covering all day rows at that x
  if(lunchIndex !== -1){
    const lx = colW + lunchIndex*colW;
    const ly = rowH; // start below header
    const lheight = rowH * tt.days.length;
    svg += `<rect x='${lx}' y='${ly}' width='${colW}' height='${lheight}' fill='#fff8e6' stroke='#ddd'/>`;
    // draw centered "LUNCH" text vertically centered in that tall rect
    svg += `<text x='${lx + colW/2}' y='${ly + lheight/2 + 4}' text-anchor='middle' fill='#b36b00' font-weight='700' font-size='11'>LUNCH</text>`;
  }

  // draw rows and cells except lunch column (we already drew lunch as tall rect)
  for(let r=0;r<tt.days.length;r++){
    const y = (r+1)*rowH;
    // day cell
    svg += `<rect x='0' y='${y}' width='${colW}' height='${rowH}' fill='#e6eef9' />`;
    svg += `<text x='${colW/2}' y='${y + rowH/2 +4}' text-anchor='middle' fill='#000'>${escapeXml(tt.days[r])}</text>`;
    // other cells
    for(let c=0;c<tt.slots.length;c++){
      if(c === lunchIndex) continue; // skip per-day lunch cell (we have the tall lunch bar)
      const x = colW + c*colW;
      svg += `<rect x='${x}' y='${y}' width='${colW}' height='${rowH}' fill='#ffffff' stroke='#ddd'/>`;
      let textVal = tt.table[tt.days[r]][c];
      if(!textVal) textVal = "";
      if(textVal.length > 8) textVal = textVal.slice(0,7) + '‚Ä¶';
      svg += `<text x='${x + colW/2}' y='${y + rowH/2 +4}' text-anchor='middle' fill='#000' font-size='9'>${escapeXml(textVal)}</text>`;
    }
  }

  svg += `</g></svg>`;
  const encoded = encodeURIComponent(svg).replace(/'/g,"%27").replace(/"/g,"%22");
  return `data:image/svg+xml;charset=utf-8,${encoded}`;
}
function escapeXml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ------------------------------
   Canteen, fee, exam helpers
   ------------------------------ */
function getCanteenHTML(){
  return `
  <div class="menu-section">
    <h4>üçõ Lunch Menu</h4>
    <ul>
      <li>Veg Thali ‚Äî ‚Çπ80</li>
      <li>Chicken Biryani ‚Äî ‚Çπ120</li>
      <li>Mutton Biryani ‚Äî ‚Çπ160</li>
      <li>Prawn Biryani ‚Äî ‚Çπ180</li>
      <li>Paneer Biryani ‚Äî ‚Çπ130</li>
      <li>Egg Biryani ‚Äî ‚Çπ100</li>
      <li>Veg Fried Rice ‚Äî ‚Çπ90</li>
      <li>Sambar Rice ‚Äî ‚Çπ60</li>
      <li>Curd Rice ‚Äî ‚Çπ50</li>
      <li>Tomato Rice ‚Äî ‚Çπ60</li>
    </ul>
    <h4>‚òï Tiffins & Snacks</h4>
    <ul>
      <li>Idli (2 pcs) ‚Äî ‚Çπ30</li>
      <li>Masala Dosa ‚Äî ‚Çπ40</li>
      <li>Plain Dosa ‚Äî ‚Çπ35</li>
      <li>Pesarattu ‚Äî ‚Çπ40</li>
      <li>Uthappam ‚Äî ‚Çπ45</li>
      <li>Mirchi Bajji (2 pcs) ‚Äî ‚Çπ25</li>
      <li>Punugulu ‚Äî ‚Çπ30</li>
      <li>Veg Puff ‚Äî ‚Çπ25</li>
      <li>Egg Puff ‚Äî ‚Çπ30</li>
      <li>Veg Sandwich ‚Äî ‚Çπ35</li>
    </ul>
    <h4>ü•§ Juices & Beverages</h4>
    <ul>
      <li>Mango Juice ‚Äî ‚Çπ40</li>
      <li>Watermelon Juice ‚Äî ‚Çπ35</li>
      <li>Grape Juice ‚Äî ‚Çπ40</li>
      <li>Cold Coffee ‚Äî ‚Çπ50</li>
      <li>Tea ‚Äî ‚Çπ15</li>
      <li>Filter Coffee ‚Äî ‚Çπ20</li>
      <li>Soft Drinks ‚Äî ‚Çπ25</li>
      <li>Buttermilk ‚Äî ‚Çπ15</li>
    </ul>
  </div>`;
}

function getFeeHTML() {
  return `
  <div>
    <p><strong>Here is the College Fee Structure:</strong></p>
    <table>
      <tr><th>Course</th><th>Fee (‚Çπ)</th></tr>
      <tr class="tooltip-row" data-full="Computer Science Engineering"><td>CSE</td><td>150000</td></tr>
      <tr class="tooltip-row" data-full="Artificial Intelligence & Machine Learning"><td>AIML</td><td>180000</td></tr>
      <tr class="tooltip-row" data-full="Data Science"><td>DS</td><td>170000</td></tr>
      <tr class="tooltip-row" data-full="Information Technology"><td>IT</td><td>140000</td></tr>
      <tr class="tooltip-row" data-full="Internet of Things"><td>IOT</td><td>140000</td></tr>
      <tr class="tooltip-row" data-full="Augmented Reality & Virtual Reality"><td>ARVR</td><td>140000</td></tr>
    </table>
    <p style="font-size:0.9em;color:#333;margin-top:8px;">Tip: Type the course code (CSE, AIML, DS, IT, IOT, ARVR) to see subjects covered across 4 years.</p>
  </div>`;
}

function examHTML(){
  let h = "<div><strong>üßæ Upcoming Exams (Nov 2025):</strong><br><ul>";
  examSchedule.forEach(e => h += `<li>${e.subject} ‚Äî ${e.date}</li>`);
  h += "</ul></div>";
  return h;
}

/* ------------------------------
   Chat rendering helpers
   ------------------------------ */
function appendMessage(sender, text) {
  const chatBox = document.getElementById("chat-box");
  const msg = document.createElement("div");
  msg.classList.add("message", sender==="user" ? "user-message":"bot-message");
  const bubble = document.createElement("div"); bubble.classList.add("bubble");
  if (sender === "user") bubble.textContent = text;
  else bubble.innerHTML = text;
  msg.appendChild(bubble);
  chatBox.appendChild(msg);
  setTimeout(()=>msg.classList.add("show"),50);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ------------------------------
   Main chat logic (attendance & timetable fixed)
   ------------------------------ */
function sendMessage(){
  const input = document.getElementById("user-input");
  const text = input.value.trim();
  if(!text) return;
  appendMessage("user", text);
  input.value = "";
  setTimeout(()=> {
    const reply = generateReply(text);
    appendMessage("bot", reply);
  }, 200);
}

function generateReply(rawMsg){
  const msg = rawMsg.trim().toLowerCase();

  if(!user.role){
    return "Please select a role first (Student / Faculty / Admin / Public) from the role selection screen.";
  }

  // canteen
  if(msg.includes("canteen") || msg.includes("menu") || msg.includes("food") || msg.includes("snack") || msg.includes("biryani")){
    return getCanteenHTML();
  }

  // events
  if(msg.includes("event") || msg.includes("events")) return formatEventsHTML();

  // fee
  if(msg.includes("fee") || msg.includes("structure")){
    if(user.role === "public") return getFeeHTML();
    return "üîí Fee structure is visible only to Public role. Switch to Public to view fees.";
  }

  // course subjects
  const keys = ["cse","aiml","ds","it","iot","arvr"];
  for(let k of keys){ if(msg.includes(k)) {
      if(courseSubjects[k]){
        let html = `<div><strong>üìò ${k.toUpperCase()} - 4 year subjects overview:</strong><ol style="margin-top:8px;">`;
        courseSubjects[k].forEach(yr => html += `<li style="margin-bottom:6px;">${yr}</li>`);
        html += `</ol></div>`;
        return html;
      }
    }
  }

  // STUDENT logic (attendance & timetable)
  if(user.role === "student"){
    // direct attendance queries -> return only number (random each time)
    // Accepts both 'attendance' and common misspelling 'attendence'
    const directAttendanceRegex = /\b(what('?s| is)?\s*my\s*(attendanc|attendenc)e|my\s*(attendanc|attendenc)e|whats\s*my\s*(attendanc|attendenc)e)\b/i;
    if(directAttendanceRegex.test(rawMsg)){
      const percent = randInt(60,95);
      return `${percent}%`;
    }

    // general attendance queries -> show percent + highlighted mandatory note + class average
    if(msg.includes("attendance") || msg.includes("attendence")){
      const percent = randInt(60,95);
      if(user.classAverageAttendance === null) user.classAverageAttendance = randInt(78,92);
      return `<div><strong>üéØ Your Attendance:</strong> ${percent}%<br><span class="highlight">‚ö†Ô∏è Minimum 75% attendance is mandatory to attend exams.</span><br><strong>Class Average Attendance:</strong> ${user.classAverageAttendance}%</div>`;
    }

    // timetable -> show small horizontal SVG + legend as line-by-line entries (bold short-code + full name)
    if(msg.includes("timetable") || msg.includes("time table") || msg.includes("schedule")){
      if(user.studentTimetable === null) user.studentTimetable = generateShortCodeTimetable();
      const dataUrl = timetableToSVGDataURLShort(user.studentTimetable);
      // legend lines (one per line, short code bold)
      const legendLines =
        `<div class="legend-line"><strong>CSE</strong> ‚Äî Computer Science & Engineering</div>` +
        `<div class="legend-line"><strong>AIML</strong> ‚Äî Artificial Intelligence & Machine Learning</div>` +
        `<div class="legend-line"><strong>DS</strong> ‚Äî Data Science</div>` +
        `<div class="legend-line"><strong>IT</strong> ‚Äî Information Technology</div>` +
        `<div class="legend-line"><strong>IOT</strong> ‚Äî Internet of Things</div>` +
        `<div class="legend-line"><strong>ARVR</strong> ‚Äî Augmented Reality & Virtual Reality</div>` +
        `<div class="legend-line"><strong>LIB</strong> ‚Äî Library</div>` +
        `<div class="legend-line"><strong>SPORTS</strong> ‚Äî Sports</div>` +
        `<div class="legend-line"><strong>DANCE</strong> ‚Äî Dance</div>`;
      return `<div><strong>üìÖ Weekly Timetable</strong><br><img src="${dataUrl}" alt="Timetable"/><br>${legendLines}</div>`;
    }

    // exams
    if(msg.includes("exam") || msg.includes("exams") || msg.includes("exam date") || msg.includes("exam dates")){
      return examHTML();
    }

    // class average/performance
    if(msg.includes("average attendance") || msg.includes("class average") || msg.includes("average")){
      if(user.classAverageAttendance === null) user.classAverageAttendance = randInt(78,92);
      return `üìà Class Average Attendance: <strong>${user.classAverageAttendance}%</strong>`;
    }

    return "You can ask: 'what's my attendance' (returns only percentage), 'attendance' (detailed + mandatory note), 'timetable' (small image + legend lines), 'exams', 'canteen', 'events', or type a course code (CSE, AIML, DS, IT, IOT, ARVR).";
  }

  // FACULTY role
  if(user.role === "faculty"){
    if(msg.includes("class average") || msg.includes("average performance") || msg.includes("performance")){
      if(user.classAveragePerformance === null) user.classAveragePerformance = randInt(70,88);
      return `üìä Class Average Performance: <strong>${user.classAveragePerformance}%</strong>`;
    }
    if(msg.includes("attendance") || msg.includes("class attendance") || msg.includes("attendence")){
      if(user.classAverageAttendance === null) user.classAverageAttendance = randInt(78,92);
      return `üìà Class Average Attendance: <strong>${user.classAverageAttendance}%</strong>`;
    }
    if(msg.includes("events") || msg.includes("event")){
      return formatEventsHTML();
    }
    return "Ask: 'class average performance', 'class attendance', 'events', or type a course code (CSE,AIML,DS,IT,IOT,ARVR) to view subjects.";
  }

  // ADMIN role
  if(user.role === "admin"){
    if(msg.startsWith("add event:") || msg.startsWith("add event")){
      const after = rawMsg.split(":").slice(1).join(":").trim();
      const parts = after.split("|").map(s=>s.trim()).filter(s=>s!=="");
      if(parts.length >= 2){
        const name = parts[0];
        const date = parts[1];
        const type = parts[2] || "technical";
        const ok = /^\d{4}-\d{2}-\d{2}$/.test(date);
        if(!ok) return "üö´ Date format invalid. Use YYYY-MM-DD (e.g. 2025-11-22).";
        events.push({ name, date, type });
        return `‚úÖ Event added: <strong>${name}</strong> ‚Äî ${date} (${type})`;
      } else {
        return "To add event use: add event: Event Name | 2025-11-12 | technical";
      }
    }

    if(msg.includes("events") || msg.includes("event")){
      return `<div><strong>Events (you can add events as admin)</strong><br>` + formatEventsHTML() + `</div>`;
    }

    if(msg.includes("performance") || msg.includes("class average")){
      if(user.classAveragePerformance === null) user.classAveragePerformance = randInt(70,88);
      return `üìä Class Average Performance (all classes): <strong>${user.classAveragePerformance}%</strong>`;
    }

    return "Admin commands: 'events' to list events, 'add event: Name | YYYY-MM-DD | type' to add, 'performance' to view class average performance.";
  }

  // PUBLIC role
  if(user.role === "public"){
    if(msg.includes("fee") || msg.includes("structure")){
      return getFeeHTML();
    }
    if(msg.includes("curriculum") || msg.includes("syllabus") || msg.includes("subject")){
      let html = "<div><strong>üìö Curriculum Summary</strong><br>";
      html += `<p><strong>CSE:</strong> Programming, Data Structures, DBMS, Operating Systems, AI</p>`;
      html += `<p><strong>AIML:</strong> Python, Machine Learning, Deep Learning, NLP</p>`;
      html += `<p><strong>DS:</strong> Statistics, Data Mining, Machine Learning, Big Data</p>`;
      html += `<p><strong>IT:</strong> Web Dev, DBMS, Networks, Cyber Security</p>`;
      html += `</div>`;
      return html;
    }
    if(msg.includes("events") || msg.includes("event")){
      return formatEventsHTML();
    }
    return "Ask: 'fee structure', 'curriculum', 'canteen', or 'events'. Type a course code (CSE,AIML,DS,IT,IOT,ARVR) to see subjects.";
  }

  // fallback
  return "I didn't get that ‚Äî try: 'canteen', 'events', course code (CSE,AIML...), 'timetable' (student), 'what's my attendance' (student), or 'fee structure' (public).";
}

/* ------------------------------
   Enter key send
   ------------------------------ */
document.getElementById("user-input").addEventListener("keydown", function(e){
  if(e.key === "Enter") sendMessage();
});
</script>
</body>
</html>
